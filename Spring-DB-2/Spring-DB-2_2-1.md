# ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ  - í…ŒìŠ¤íŠ¸
## ë°ì´í„° ë² ì´ìŠ¤ ë¡¤ë°±
>DBì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ì¡°íšŒí•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„± í•œë‹¤ ì´ë•Œ ì—¬ëŸ¬ê°€ì§€ ì™¸ë¶€ ì¡°ê±´ì— ì˜í•´ì„œ í…ŒìŠ¤íŠ¸ ì½”ë“œì˜ ê²°ê³¼ê°€ ë‹¤ë¥´ê²Œ ë‚˜ì˜¤ëŠ”ë° ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ í…ŒìŠ¤íŠ¸ë¥¼ ë‹¤ë¥¸ í™˜ê²½ê³¼ ì² ì €í•˜ê²Œ ë¶„ë¦¬í•´ì•¼ í•œë‹¤.

- ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•ì€ í…ŒìŠ¤íŠ¸ ì „ìš© ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³„ë„ë¡œ ìš´ì˜í•˜ëŠ” ê²ƒì´ë‹¤.
  - H2 ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìš©ë„ì— ë”°ë¼ 2ê°€ì§€ë¡œ êµ¬ë¶„í•˜ë©´ ëœë‹¤.
    - `jdbc:h2:tcp://localhost/~/test` localì—ì„œ ì ‘ê·¼í•˜ëŠ” ì„œë²„ ì „ìš© ë°ì´í„°ë² ì´ìŠ¤
    - `jdbc:h2:tcp://localhost/~/testcase` test ì¼€ì´ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì „ìš© ë°ì´í„°ë² ì´ìŠ¤

ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¶„ë¦¬í–ˆì§€ë§Œ í…ŒìŠ¤íŠ¸ ë„ì¤‘ì— ë‚¨ê¸´ ë°ì´í„°ê°€ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘ ì˜¤ë¥˜ë¥¼ ë°œìƒ ì‹œí‚¬ìˆ˜ ìˆë‹¤.

í…ŒìŠ¤íŠ¸ì—ì„œ ë§¤ìš° ì¤‘ìš”í•œ ì›ì¹™ì€ ë‹¤ìŒê³¼ ê°™ë‹¤. 
- **í…ŒìŠ¤íŠ¸ëŠ” ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ì™€ ê²©ë¦¬í•´ì•¼ í•œë‹¤.**
- **í…ŒìŠ¤íŠ¸ëŠ” ë°˜ë³µí•´ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.**

ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ë°ì´í„° ë¡¤ë°±ì„ ì‚¬ìš©í•œë‹¤.

### í…ŒìŠ¤íŠ¸ - ë°ì´í„° ë¡¤ë°± 
**íŠ¸ëœì­ì…˜ê³¼ ë¡¤ë°± ì „ëµ**
- í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ê³  ë‚˜ì„œ íŠ¸ëœì­ì…˜ì„ ê°•ì œë¡œ ë¡¤ë°±í•´ë²„ë¦¬ë©´ ë°ì´í„°ê°€ ê¹”ë”í•˜ê²Œ ì œê±°ëœë‹¤.
- í…ŒìŠ¤íŠ¸ë¥¼ í•˜ë©´ì„œ ë°ì´í„°ë¥¼ ì´ë¯¸ ì €ì¥í–ˆëŠ”ë°, ì¤‘ê°„ì— í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ì„œ ë¡¤ë°±ì„ í˜¸ì¶œí•˜ì§€ ëª»í•´ë„ ê´œì°®ë‹¤.
  - íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ë°ì´í„°ë² ì´ìŠ¤ì— í•´ë‹¹ ë°ì´í„°ê°€ ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ë™ì‘ ìˆœì„œ
```text
1. íŠ¸ëœì­ì…˜ ì‹œì‘
2. í…ŒìŠ¤íŠ¸ A ì‹¤í–‰
3. íŠ¸ëœì­ì…˜ ë¡¤ë°±

4. íŠ¸ëœì­ì…˜ ì‹œì‘
5. í…ŒìŠ¤íŠ¸ B ì‹¤í–‰
6. íŠ¸ëœì­ì…˜ ë¡¤ë°±
```

í…ŒìŠ¤íŠ¸ëŠ” ê°ê°ì˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ í›„ë¡œ ë™ì‘í•˜ëŠ” `@BeforeEach` , `@AfterEach` ë¥¼ ì‚¬ìš©í•´ ë¡¤ë°±ì„ ì ìš© ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

```java
package hello.itemservice.domain;

import hello.itemservice.repository.ItemRepository;
import hello.itemservice.repository.ItemSearchCond;
import hello.itemservice.repository.ItemUpdateDto;
import hello.itemservice.repository.memory.MemoryItemRepository;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.List;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.TransactionStatus;
import org.springframework.transaction.support.DefaultTransactionDefinition;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
class ItemRepositoryTest {

    @Autowired
    ItemRepository itemRepository;


    @Autowired
    PlatformTransactionManager transactionManager;
    TransactionStatus status;

    @BeforeEach
    void before(){
        // íŠ¸ëœì­ì…” ì‹œì‘
        status = transactionManager.getTransaction(new DefaultTransactionDefinition());
    }

    @AfterEach
    void afterEach() {
        //MemoryItemRepository ì˜ ê²½ìš° ì œí•œì ìœ¼ë¡œ ì‚¬ìš©
        if (itemRepository instanceof MemoryItemRepository) {
            ((MemoryItemRepository) itemRepository).clearStore();
        }

        transactionManager.rollback(status);
    }

    @Test
    void save() {
        //given
        Item item = new Item("itemA", 10000, 10);

        //when
        Item savedItem = itemRepository.save(item);

        //then
        Item findItem = itemRepository.findById(item.getId()).get();
        assertThat(findItem).isEqualTo(savedItem);
    }

    @Test
    void updateItem() {
        //given
        Item item = new Item("item1", 10000, 10);
        Item savedItem = itemRepository.save(item);
        Long itemId = savedItem.getId();

        //when
        ItemUpdateDto updateParam = new ItemUpdateDto("item2", 20000, 30);
        itemRepository.update(itemId, updateParam);

        //then
        Item findItem = itemRepository.findById(itemId).get();
        assertThat(findItem.getItemName()).isEqualTo(updateParam.getItemName());
        assertThat(findItem.getPrice()).isEqualTo(updateParam.getPrice());
        assertThat(findItem.getQuantity()).isEqualTo(updateParam.getQuantity());
    }

    @Test
    void findItems() {
        //given
        Item item1 = new Item("itemA-1", 10000, 10);
        Item item2 = new Item("itemA-2", 20000, 20);
        Item item3 = new Item("itemB-1", 30000, 30);

        itemRepository.save(item1);
        itemRepository.save(item2);
        itemRepository.save(item3);

        //ë‘˜ ë‹¤ ì—†ìŒ ê²€ì¦
        test(null, null, item1, item2, item3);
        test("", null, item1, item2, item3);

        //itemName ê²€ì¦
        test("itemA", null, item1, item2);
        test("temA", null, item1, item2);
        test("itemB", null, item3);

        //maxPrice ê²€ì¦
        test(null, 10000, item1);

        //ë‘˜ ë‹¤ ìˆìŒ ê²€ì¦
        test("itemA", 10000, item1);
    }

    void test(String itemName, Integer maxPrice, Item... items) {
        List<Item> result = itemRepository.findAll(new ItemSearchCond(itemName, maxPrice));
        assertThat(result).containsExactly(items);
    }
}
```
- íŠ¸ëœì­ì…˜ ê´€ë¦¬ìëŠ” `PlatformTransactionManager` ë¥¼ ì£¼ì… ë°›ì•„ì„œ ì‚¬ìš©í•˜ë©´ ëœë‹¤
- `@BeforeEach` : ê°ê°ì˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê¸° ì§ì „ì— í˜¸ì¶œëœë‹¤.
- `@AfterEach` : ê°ê°ì˜ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ ì™„ë£Œëœ ì§í›„ì— í˜¸ì¶œëœë‹¤.

`ì´ì œ ì´ í…ŒìŠ¤íŠ¸ë¥¼ ë°˜ë³µì ìœ¼ë¡œ ì‹¤í–‰ ì‹œì¼œë„ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•œë‹¤!`ğŸ˜€


## @Transactional ì‚¬ìš©
>ë§¤ë²ˆ `@BeforeEach` , `@AfterEach` ë¥¼ ì‚¬ìš©í•´ ë¡¤ë°±ì„ í•˜ëŠ” ê±´ ë¶ˆí¸í•˜ë‹¤. ê·¸ë˜ì„œ ìŠ¤í”„ë§ì—ì„œ ì œê³µí•˜ëŠ” `@Transactional` ì• ë…¸í…Œì´ì…˜ì€ ë¡œì§ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ë˜ë©´ ì»¤ë°‹í•˜ë„ë¡ ë™ì‘í•œë‹¤. `@Transactional` ì• ë…¸í…Œì´ì…˜ì„ í…ŒìŠ¤íŠ¸ì—ì„œ ì‚¬ìš©í•˜ë©´ ì•„ì£¼ íŠ¹ë³„í•˜ê²Œ ë™ì‘í•œë‹¤.

**ItemRepositoryTest - @Transactional ì‚¬ìš©**
```java
package hello.itemservice.domain;

import org.springframework.transaction.annotation.Transactional;
import ...

@Transactional
@SpringBootTest
class ItemRepositoryTest {

    @Autowired
    ItemRepository itemRepository;


//    @Autowired
//    PlatformTransactionManager transactionManager;
//    TransactionStatus status;

//    @BeforeEach
//    void before(){
//        // íŠ¸ëœì­ì…” ì‹œì‘
//        status = transactionManager.getTransaction(new DefaultTransactionDefinition());
//    }

    @AfterEach
    void afterEach() {
        //MemoryItemRepository ì˜ ê²½ìš° ì œí•œì ìœ¼ë¡œ ì‚¬ìš©
        if (itemRepository instanceof MemoryItemRepository) {
            ((MemoryItemRepository) itemRepository).clearStore();
        }

        //transactionManager.rollback(status);
    }

    @Test
    void save() {
        //given
        Item item = new Item("itemA", 10000, 10);

        //when
        Item savedItem = itemRepository.save(item);

        //then
        Item findItem = itemRepository.findById(item.getId()).get();
        assertThat(findItem).isEqualTo(savedItem);
    }

    @Test
    void updateItem() {
        //given
        Item item = new Item("item1", 10000, 10);
        Item savedItem = itemRepository.save(item);
        Long itemId = savedItem.getId();

        //when
        ItemUpdateDto updateParam = new ItemUpdateDto("item2", 20000, 30);
        itemRepository.update(itemId, updateParam);

        //then
        Item findItem = itemRepository.findById(itemId).get();
        assertThat(findItem.getItemName()).isEqualTo(updateParam.getItemName());
        assertThat(findItem.getPrice()).isEqualTo(updateParam.getPrice());
        assertThat(findItem.getQuantity()).isEqualTo(updateParam.getQuantity());
    }

    @Test
    void findItems() {
        //given
        Item item1 = new Item("itemA-1", 10000, 10);
        Item item2 = new Item("itemA-2", 20000, 20);
        Item item3 = new Item("itemB-1", 30000, 30);

        itemRepository.save(item1);
        itemRepository.save(item2);
        itemRepository.save(item3);

        //ë‘˜ ë‹¤ ì—†ìŒ ê²€ì¦
        test(null, null, item1, item2, item3);
        test("", null, item1, item2, item3);

        //itemName ê²€ì¦
        test("itemA", null, item1, item2);
        test("temA", null, item1, item2);
        test("itemB", null, item3);

        //maxPrice ê²€ì¦
        test(null, 10000, item1);

        //ë‘˜ ë‹¤ ìˆìŒ ê²€ì¦
        test("itemA", 10000, item1);
    }

    void test(String itemName, Integer maxPrice, Item... items) {
        List<Item> result = itemRepository.findAll(new ItemSearchCond(itemName, maxPrice));
        assertThat(result).containsExactly(items);
    }
}
```

**@Transactional ë™ì‘ ë°©ì‹**

![image](https://github.com/user-attachments/assets/235988af-ccc1-4f43-aaac-28d61b57de62)

>**ì°¸ê³ **
>
>í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì˜ ë©”ì„œë“œë‚˜ í´ë˜ìŠ¤ì— `@Transactional` ì„ ì§ì ‘ ë¶™ì—¬ì„œ ì‚¬ìš©í•  ë•Œ ë§Œ ì´ë ‡ê²Œ ë™ì‘í•œë‹¤.
>ê·¸ë¦¬ê³  íŠ¸ëœì­ì…˜ì„ í…ŒìŠ¤íŠ¸ì—ì„œ ì‹œì‘í•˜ê¸° ë•Œë¬¸ì— ì„œë¹„ìŠ¤, ë¦¬í¬ì§€í† ë¦¬ì— ìˆëŠ” `@Transactional` ë„ í…ŒìŠ¤íŠ¸ì—ì„œ ì‹œì‘í•œ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•œë‹¤. (ì´ ë¶€ë¶„ì€ ë’¤ì— íŠ¸ëœì­ì…˜ ì „íŒŒì—ì„œ ë” ìì„¸íˆ ì„¤ëª…>í•˜ê² ë‹¤. ì§€ê¸ˆì€ í…ŒìŠ¤íŠ¸ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‹¤í–‰í•˜ë©´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì´ ì¢…ë£Œë  ë•Œ ê¹Œì§€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰í•˜ëŠ” ëª¨ë“  ì½”ë“œê°€ ê°™ì€ íŠ¸ëœì­ì…˜ ë²”ìœ„ì— ë“¤ì–´ê°„ë‹¤ê³  ì´í•´í•˜ë©´ ëœë‹¤. ê°™ì€ ë²”ìœ„ë¼ëŠ” ëœ»ì€ ì‰½ê²Œ ì´ì•¼ê¸°í•´ì„œ ê°™ì€ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•œë‹¤ëŠ” ëœ»ì´ë‹¤. ê·¸ë¦¬ê³  ê°™ì€ íŠ¸ëœì­ì…˜ ì„ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì€ ê°™ì€ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•œë‹¤ëŠ” ëœ»ì´ê¸°ë„ í•˜ë‹¤.)


ì´ì œ ë‚´ê°€ ì§ì ‘ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì§€ ì•Šì•„ë„ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë¡¤ë°± ëœë‹¤. ë˜í•œ íŠ¸ëœì­ì…˜ ë²”ìœ„ ì•ˆì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì— ë™ì‹œì— ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ê°€ ì§„í–‰ë˜ì–´ë„ ì„œë¡œ ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ” ì¥ì ì´ ìˆë‹¤. 

`@Transactional` ë•ë¶„ì— ì•„ì£¼ í¸ë¦¬í•˜ê²Œ ë‹¤ìŒ ì›ì¹™ì„ ì§€í‚¬ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤. 
- í…ŒìŠ¤íŠ¸ëŠ” ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ì™€ ê²©ë¦¬í•´ì•¼ í•œë‹¤.
- í…ŒìŠ¤íŠ¸ëŠ” ë°˜ë³µí•´ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

