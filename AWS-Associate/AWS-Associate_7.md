## 1. 고가용성 및 확장성

**확장성 : 애플리케이션 시스템이 조정을 통해 더 많은 양을 처리할 수 있다는 의미**

- 수직 확장성 : 인스턴스 크기를 확장하는 것
    - ex) t2.micro 구동 되는 애플리케이션을 t2.large 에서 구동되도록 확장
    - 일반적으로 확장할 수 있는 정도에는 하드웨어 제한이 걸려있다.
- 수평 확장성 : 인스턴스의 수를 늘리는 것
    - 클라우드 시스템의 장점으로 수평 확장성이 수월해짐
    - 분배 시스템으로 이루어져 있다.
    - **스케일 아웃 (확장)**
    - **스케일 인(감소)**

**고가용성 : 애플리케이션 또는 시스템을 2개 이상의 AWS의 AZ나 데이터 센터에서 가동 중이라는 것을 의미**

- 데이터 센터의 손실에서 살아 남는 것으로 센터 하나가 멈춰도 계속 작동이 가능하게끔 하는 것

## 2. 로드 벨런싱

로드 벨런서 : 서버 혹은 서버셋으로 트래픽을 백엔드나 다운 스트림 EC2 인스턴스 또는 서버들로 전달하는 역할



- 사용자들은 인스턴스에 접근하기 전에 로드벨런서를 거친다
- 로드벨런서를 통해 인스턴스를 연결 시키기 때문에 많은 유저가 들어올때 부하가 분산된다.
- 사용자들은 백엔드 인스턴스 중 어떤 것에 연결되어 있는지 알 수 없다.
    - 단일 DNS로 접속하면 로드벨런서가 알아서 처리

**로드 벨러서가 필요한 이유**

- 부하를 다수의 다운스트림 인스턴스로 분산하기 위해서이다.
- 단일 DNS을 노출해 다운스트림 인스턴스 장애를 원활이 처리할 수 있다.
- 상태 확인 매커니즘을 통해 인스턴스의 상태를 확인할 수 있다.
- SSL 종료 가능
- HTTPS 트래픽 사용 가능
- 일래스틱 로드 밸런서는 관리형 로드 밸런서이다.
    - AWS가 관리하며, 어떤 경우에도 작동할 것을 보장
    - AWS가 업그레이드와 유지 관리 및 고가용성을 책임
    - 자체 로드 벨런서 보다 저렴하고 관리가 편함

**로드 벨런서 상태 확인**

- 인스턴스 작동이 올바르게 이뤄지고 있는지 여부를 확인


- HTTP 상태 코드로 200으로 응답하지 않으면 상태가 좋지 않다고 기록
    - 트래픽을 차단

**관리형 로드 벨런서의 종류 4가지**

- 클래식 로드 벨런서(CLB) **(CLB는 AWS에서 더 이상 사용 X, 시험 X**)
    - HTTP, HTTPS, TCP, SSL와 secure TCP를 지원
    - 사용을 권장하지 않음
- 어플리케이션 로드 벨런서(ALB)
    - HTTP, HTTPS와 WebSocket 프로토콜을 지원
- 네트워크 로드 벨런서(NLB)
    - TCP, TLS, secure TCP와 UDP 프로토콜을 지원
- 게이트웨이 로드 벨런서(GWLB)
    - 네트워크층에서 작동
    - 3계층과 IP 프로토콜에서 작동

**로드 벨런서 보안 그룹**



- 유저는 HTTP와 HTTPS를 사용해 어디서든 로드 벨런서에 접근이 가능
    - `0.0.0.0/0`  어디든 가능하다는 뜻
- EC2 인스턴스의 보안 그룹을 로드 벨런서의 보안 그룹으로 연결
    - 강화된 보안 매커니즘

### ALB

- URL 대상 경로 라우팅 지원
- 마이크로 서비스나 컨테이너 기반 애플리케이션에 가장 좋은 로드 벨런서
- 도커와 Amazon EC2의 경우 가장 적합한 로드 벨런서
    - 동적 포트로 리다이렉션을 가능하게 함
- 하나의 ABL은 다수의 애플리케이션을 처리할 수 있다.


- ALB : URL에서 사용되는 라우팅을 기반으로 각 대상 그룹에 지능적으로 라우팅하는 방법
- 첫 번째 대상 그룹 : Route /user로 라우팅
    - 유저 애플리케이션으로 작동
- 두 번째 대상 그룹 : /search라는 규칙에 따라 라우팅
    - 검색 애플리케이션으로 작동

**대상 그룹이란**

- EC2 인스턴스가 대상 그룹이 될 수 있다
    - 이들은 오토 스케일링 그룹에 의해 관리

**작동 예시**


- AWS 기반의 EC2 인스턴스 : 모바일 기반 트래픽 전체
- 데이터 센터 내부의 온프레미스 개인 서버 : 데스크탑 기반 트래픽 전체
- 이런 경우에는 쿼리 문자열이나 매개변수 라우팅을 사용
- ALB에서 리다이렉션 라우팅 규칙을 만들 수 있다
    - 클라이언트가 사용하려는 URL에 `?Platform=Mobile`이 있는 경우
        - 첫 번째 대상 그룹으로 리다이렉팅
    - 클라이언트가 사용하려는 URL에 `?Platform=Desktop`이  있는 경우
        - 쿼리 문자열 또는 매개변수인 경우
        - 두 번째 대상 그룹으로 리다이렉트
    

### NLB

- 4계층 로드 벨런서이므로 TCP와 UDP 트래픽을 처리할 수 있다.
- 지연시간이 애플리케이션 로드 벨런서 보다 짧고 고성능이다.
- 가용 영역 하나당 하나의 고정 IP만 있다
    - 각 가용 영역에 탄력적 IP를 적용할 수 있다.
    - ex) 애플리케이션이 1개, 혹은 서로 다른 2개, 3개의 IP로만 액세스 가능
- NLB의 대상 그룹이 하는 상태 확인(**세 가지 프로토콜**)
    - TCP, HTTP, HTTPS
- NLB는 AWS 프리 티어 X



- case 1 : NLB가 EC2 인스턴스로 리디렉션할 수 있고, TCP와 UDP 트래픽을 그쪽으로 보낼 수 있다
- case 2 : IP 주소도 등록할 수 있다, 이 주소는 하드 코딩되어 있어야 한다(프라이빗 IP 주소)
    - 소유한 EC2 인스턴스의 프라이빗 IP 외에도 데이터 센터에 있는 서버의 프라이빗 IP 사용가능
- case 3 : 애플리케이션 로드 밸런서 앞에 NLB 두기
    - NLB가 ALB 앞에 존재
    - NLB 덕분에 고정 IP 주소를 얻을 수 있고 ALB 덕분에
        - HTTP 트래픽을 처리하는 것과 관련한 모든 규칙을 얻을 수 있다.
        

### GWLB

- 가장 최근의 로드 벨런서
- 배포 및 확장과 AWS의 타사 네트워크 가상 어플라이언스 플릿 관리에 사용된다
- 방화벽을 통과하게 하거나 침입 탐지 및 방지 시스템에 사용


- 트래픽은 사용자에서 ALB와 애플리케이션으로 바로 이동한다.
- 모든 트래픽을 검사하려면 GWLB를  사용
- GWLB를 생성하면 VPC에서 라우팅 테이블이 업데이트된다.
- 라우팅 테이블이 수정되면 사용자 트레픽은 GWLB를 통과하고 GWLB는 가상 어플라이언스의 대상 그룹 전반으로 트래픽을 확산한다.
- 그래서 어플라이언스는 트래픽을 분석하고 처리한다.
- 방화벽이나 침입 탐지와 같이

- GWLB의 기능은 네트워크 트래픽을 분석하는 것
- IP 패킷의 네트워크 계층인 L3
- 투명 네트워크 게이트웨이
    - VCP의 모든 트래픽이 GWLB가 되는 단일 엔트리와 출구를 통과하기 때문
- 대상 그룹의 가상 어플라이언스 집합에 전반적으로 그 트래픽을 분산해 로드 밸런서가 된다.

### ELB 고정 세션(세션 밀접성)

- 클라이언트가 인스턴스에 접근할때  로드 벨런서(ALB)를 요청을 확산 시키는데
- 고정 세션을 실행하면 쿠키를 통해 응답하는 인스턴스가 고정된다.
- 모든 요청을 확산하는 것과는 다른 동작
- 클라이언트에서 로드 밸런서로 요청의 일부로서 전송된다.
    - 고정성과 만료 기간이 있다.
    - 쿠기가 만료되면 다른 인스턴스로 리다이렉션 된다.
- 사용자의 로그인과 같은 중요한 정보를 취하는 세션 데이터를 잃지 않기 위해 사용자가 동일한 백엔드 인스턴스에 연결
- 백엔드 EC2 인스턴스 부하에 불균형을 초래


**고정 세션의 유형**

- 애플리케이션 기반 쿠키
    - 사용자 정의 쿠키로 애플리케이션에 생성
    - 애플리케이션에 필요한 모든 사용자 정의 속성을 포함
    - 쿠키의 이름은 각 대상 그룹별로 개별적으로 지정해야 한다
- 기간 기반의 쿠키
    - 특정 기간을 기반으로 만료되며 그 기간이 로드 밸런서 자체에서 생성
- 로드 밸런서에서 생성되는 쿠키
    - AWSALB, AWSALBAPP , AWSALBTG 은 사용 X(ELB 에서 사용)
    

**Cross-Zone Load Balancing - 교차 영역 벨런싱**

- 클라이언트가 인스턴스에 접근 할 때 각 로드 벨런스는 모든 가용 영역에 등록된 모든 인스턴스에 고르게 분포된다.



- ALB
    - 기본적으로 교차 영역 로드 밸런싱이 활성화
    - AZ를 교차하는 데이터에 대해서는 비용이 부과 X
- NLB, GWLB
    - AZ를 교차하는 데이터에 대해서는 비용이 부과

## 3. SSL / TLS 인증서

SSL 인증서는 클라이언트와 로드 벨런서 사이에서 트래픽이 전송되는 동안 암호화 함

- 데이터가 네트워크를 통과하는 중에 암호화되어 있고 발신자와 수신자만 해독할 수 있음.
- SSL : 보안 소켓 계층 , 연결을 암호화 할 때 사용
- TLS : SSL의 새로운 버전, 전송 계층 보안을 의미
- 퍼블릭 SSL 인증서는 인증 기관에서 발행한다.
- 사용자는 HTTPS를 통해 SSL 인증서를 사용해 암호화 한다.



공용 인터넷을 통해 로드 벨런서에 연결하고 내부적으로 로드 벨런서는 SSL 종료를 하고, 백엔드에서는 HTTP를 통해 EC2 인스턴스와 통신한다.

AWS 에서는 ACM(AWS 인증서 매니저)을 활용해 SSL 인증서 관리

 **SNI (Sever Name Indication)**

- 하나의 웹 서버에 여러 SSL 인증서를 로드해 웹 서버가 여러 웹사이트를 지원하게 만드는 방법


- ALB와 두 대상 그룹이 있다
    - www.mycorp.com
    - Domain1.example.com
    - 각 그룹에 맞는 각각의 SSL 인증서가 있다.
- 클라이언트가 우리 ALB에 연결하여 www.mycorp.com 를 원한다면
- 알맞은 SSL 인증서를 로드해서 맞는 대상 그룹과 연결한다.
- ALB (v2) :   SSL 인증서로 여러 리스너를 지원
- NLB :  SSL 인증서로 여러 리스너를 지원

**연결 드레이닝(등록 취소 지연)**




- 인스턴스가 등록 취소, 또는 비정상 상태인 경우
- 인스턴스에 어느 정도의 시간을 주어 인-플라이트 요청(활성 요청)을 완료할 수 있도록 하는 기능
    - 3개의 인스턴스중 1번 인스턴스를 드레이닝 모드로 설정
    - EC2 인스턴스에 연결되어 있는 유저는 드레이닝 시간을 얻게되고 기존 연결 및 기존 요청을 완료
    - 1번 인스턴스가 드레이닝 모드일 경우 새로운 연결은 2, 3번 인스턴스로 연결
        - 짧은 요청일 경우 낮은 값으로 설정(요청 시간이 매우 길 경우 높은 값으로 설정)
        - 값이 0이면 드레이닝이 일어나지 않는다는 뜻

## 4. ASG (Auto Scaling Group)

- 애플리케이션은 배포 후 시간이 지나면서 로드가 변할 수 있다.
- AWS에서 EC2 인스턴스를 API 호출로 빠르게 서버를 생성하고 제거할 수 있다.
- 이를 자동화 하는 기능이 ASG 이다.
- ASG 와 로드 벨런스를 연결하면 ASG에 포함된 인스턴스가 로드 벨런서에 연결
- 비정상적인 인스턴스를 감지하면 이것을 종료하고 새 EC2 인스턴스를 만든다
- ASG는 무료이며, 생성된 EC2 인스턴스와 리소스 비용만 지불하면된다.

**스케일 아웃**

- EC2 인스턴스를 추가해서 늘어난 로드에 맞춰 크기를 늘리는 것
- 최대 인스턴스 수를 정할 수 있다.

**스케일 인**

- EC2 인스턴스를 감소 시켜 줄어든 로드에 맞춰 크기를 줄이는 것
- 최소 인스턴스 수를 정할 수 있다.

### ASG 작동 방법




- 최소 용량 : ASG 에서 필요한 최소한의 EC2 인스턴스 수
- 원하는 용량 : ASG에 희망 인스턴스 수
- 최대 용량 : ASG 에서 사용할 최대의 EC2 인스턴스 수



- ASG는 ELB와 함께 작동한다.
- ELB를 통해 상태확인 결과를 ASG로 받을 수 있다
    - 비정상적일 경우 인스턴스를 종료할 수 있다.
- 스케일 아웃으로 인스턴스가 늘어나면 ELB를 통해 부하를 분산시킨다.

### ASG 생성

- ASG를 생성하기 위한 속성 면에서 시작 템플릿을 만들어야한다.
- 시작 템플릿




- ASG에서 EC2 인스턴스를 시작하는 방법에 관한 정보
- AMI, 인스턴스 유형, EC2 사용자 데이터, EBS 볼륨, 보안 그룹 SSH 키 페어, EC2 인스턴스를 위한 IAM 역할, 네트워크와 서브넷 정보, 로드 밸런서 정보와 그 외 정보 포함
- 이 매개변수는 EC2 인스턴스를 생성할 때 지정한 매개변수와 유사하다.
- 추가로는 ASG의 최소 크기, 최대 크기, 초기 용량과 스케일링 정책을 정의한다.

**CloudWatch**

- CloudWatch 경보 : `스케일 아웃/인`이 발생했을 때 경보를 울리고 `스케일 아웃/인`이 동작
- 평균 CPU를 관찰할 수 있는 지표나 원하는 사용자 지정 지표에서 경보가 발생

### ASG 정책

**동적 스케일링 정책(**세 가지 유형**)**

- 대상 추적 스케일링
    - 기본 기준선을 세우고 상시 가용이 가능하도록
    - 가장 단순하고 설정하기도 쉽다
    - 모든 EC2 인스턴스에서 평균 CPU 사용률을 추적하여  40% 대에 머무를 수 있도록 할 때에 사용 가능
- 단순과 단계 스케일링
    - 다음과 같이 설정 가능
        - 전체 ASG에 대한 CPU 사용률이 70%를 초과하는 경우
            - 스케일 아웃 적용
        - CPU 사용률이 30% 이하로 떨어지면
            - 유닛 하나를 제거(스케일 인)
    - CloudWatch 경보를 설정
        - 한 번에 추가할 유닛의 수와 한 번에 제거할 유닛의 수를 정의
- 예측 스케일링
    - 사용 패턴을 바탕으로 스케일링을 예상
    - AWS 내 오토 스케일링 서비스를 활용하여 지속적으로 예측을 생성
        - 과거 로드를 분석 에측 생성
    - ASG 오토 스케일링 중 하나인 예측 스케일링이 향후 더욱 대두
    

**스케일링 기반 지표**

- CPU 사용률
- 테스트를 기반으로 하는 대상별 요청의 수




**스케일링 휴지(Scaling Cooldown)**

- 스케일링 작업이 끝날 때마다 기본적으로 5분 혹은 300초의 휴지 기간을 갖는 것
- 새로운 인스턴스가 안정화될 수 있도록

<aside>
💡 즉시 사용이 가능한 AMI를 이용하여 EC2 인스턴스 구성 시간을 단축하고 이를 통해 요청을 좀 더 신속히 처리하는 것이 좋다. EC2 인스턴스 구성에 할애되는 시간이 적으면 즉시 적용이 가능. 이렇게 활성화 시간이 빨라지면 휴지 기간 또한 단축. ASG 상에서 더 많은 동적 스케일링이 가능

</aside>

## 문제

1. Application Load Balancer를 사용하여 EC2 인스턴스에서 호스팅되는 웹 사이트로 트래픽을 분산하고 있습니다. 웹 사이트는 실제로 Application Load Balancer의 IP 주소인 프라이빗 IPv4 주소에서 오는 트래픽만 보는 것으로 나타났습니다. 웹사이트에 연결된 클라이언트의 IP 주소를 얻으려면 어떻게 해야 할까요?



<aside>
💡 Application Load Balancer를 사용하여 EC2 인스턴스로 트래픽을 분산할 때 요청을 수신하는 IP 주소는 ALB의 프라이빗 IP 주소가 됩니다. 클라이언트의 IP 주소를 가져오기 위해 ALB는 클라이언트의 IP 주소를 포함하는 X-Forwarded-For라는 추가 헤더를 추가합니다.

</aside>

1. ELB가 전면에 있는 일련의 EC2 인스턴스에서 애플리케이션을 호스팅했습니다. 일주일 후 사용자는 애플리케이션이 때때로 작동하지 않는다고 불평하기 시작합니다. 문제를 조사한 결과 일부 EC2 인스턴스가 때때로 충돌하는 것을 발견했습니다. 사용자가 충돌하는 EC2 인스턴스에 연결하지 못하도록 보호하려면 어떻게 해야 할까요?




<aside>
💡 ELB Health Checks를 활성화하면 ELB가 비정상(충돌) EC2 인스턴스로 트래픽을 보내지 않습니다.

</aside>